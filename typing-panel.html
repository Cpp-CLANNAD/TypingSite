<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .typing-panel {
            width: 780px;
            border: 3px solid green;
            border-radius: 6px;
            overflow: hidden;
            padding: 5px;
        }

        .tp-word-box,
        .tp-symbol-box {
            border: 2px solid green;
            border-radius: 4px;
            width: 60px;
            float: left;
            margin: 0 5px;
        }

        .tp-pinyin {
            height: 22px;
            line-height: 22px;
            text-align: center;
        }

        .tp-pinyin > .tp-sm {
            color: red;
        }

        .tp-pinyin > .tp-ym {
            color: green;
        }

        .tp-word {
            line-height: 55px;
            font-size: 26px;
            font-weight: normal;
            text-align: center;
        }

        .tp-keys {
            height: 22px;
            line-height: 22px;
            text-align: center;
        }

        .tp-word-box.waiting-enter-sm .tp-sm {
            text-decoration: underline;
        }

        .tp-word-box.waiting-enter-ym .tp-ym {
            text-decoration: underline;
        }

        .tp-word-box.word-enter-finish .tp-word {
            color: green;
        }

        .tp-word-box.word-enter-finish + .tp-symbol-box {
            color: green;
        }

        .hidden-over.typing-panel .tp-word-box.word-enter-finish,
        .hidden-over.typing-panel .tp-word-box.word-enter-finish + .tp-symbol-box {
            display: none;
        }

        .no-pinyin.typing-panel .tp-pinyin {
            display: none;
        }

        .no-shuangpin.typing-panel .tp-keys {
            display: none;
        }
    </style>
</head>
<body>
    <article class="typing-panel">
        <div class="tp-word-box">
            <div class="tp-pinyin">
                <span class="tp-sm"></span>
                <span class="tp-ym"></span>
            </div>
            <div class="tp-word"></div>
            <div class="tp-keys">
                <span class="tp-sm"></span>
                <span class="tp-ym"></span>
            </div>
        </div>
    </article>

    <script src="shuangpinKeyMap.js"></script>

    <script>
        
    var article = [
        {
            "word": "偶",
            "desc": ["ǒu"],
            "dmap": ["ou"]
        },
        {
            "word": "昂",
            "desc": ["áng"],
            "dmap": ["ang"]
        },
        {
            "word": "天",
            "desc": ["t", "iān"],
            "dmap": ["t", "ian"]
        },
        {
            "word": "只",
            "desc": ["zh", "ǐ"],
            "dmap": ["zh", "i"]
        },
        {
            "word": "啊",
            "desc": ["a"],
            "dmap": ["a"]
        },
        {
            "word": "！"
        },
        {
            "word": "偶",
            "desc": ["ǒu"],
            "dmap": ["ou"]
        },
        {
            "word": "昂",
            "desc": ["áng"],
            "dmap": ["ang"]
        },
        {
            "word": "天",
            "desc": ["t", "iān"],
            "dmap": ["t", "ian"]
        },
        {
            "word": "只",
            "desc": ["zh", "ǐ"],
            "dmap": ["zh", "i"]
        },
        {
            "word": "啊",
            "desc": ["a"],
            "dmap": ["a"]
        },
        {
            "word": "！"
        }
    ];

    // 零声母拼音转换为双拼形式
    function lingshengmuToShuangping(val ,type) {
        var vals = ['a', 'an', 'ai', 'ao', 'ang', 'e', 'en', 'ei', 'er', 'eng', 'o', 'ou'];

        if(vals.includes(val) === false) throw new Error();

        switch(type) {
            case 1:
                return [val[0], val];
            case 2:
                if(val.length === 2)
                    return [val[0], val[1]];
                else
                    return [val[0], val];
            default:
                if(typeof type === 'string' && type.length === 1)
                    return [type, val];
                else
                    throw new Error();
        }
    }

    function reverseShuangpinKeyMap(keyMap) {
        var rv = {};
        for(let key in keyMap) {
            if(!keyMap.hasOwnProperty(key)) break;
            
            let val = keyMap[key];

            // 声母
            if(val[0]) {
                rv[val[0]] = key;
            }

            // 韵母
            for(let ym of val[1]) {
                rv[ym] = key;
            }
        }

        return rv;
    }
    

    class TypingPanel {
        constructor() {
            this.init();
        }

        createView() {
            var rvKeyMap = reverseShuangpinKeyMap(shuangpinKeyMap['小鹤双拼']['key_map']);
            var html = '';
            html += '<article class="typing-panel">';
            for(let wordInfo of article) {
                let{word, desc, dmap} = wordInfo;

                if(!(desc === undefined && dmap === undefined || desc.length === dmap.length)) throw new Error();

                if(desc && desc.length === 1) {
                    // 扩展零声母拼音数组
                    desc = ['', ...desc];
                    dmap = lingshengmuToShuangping(dmap[0], shuangpinKeyMap['小鹤双拼']['0']);
                }
                
                html += `
                <div class="${desc ? 'tp-word-box' : 'tp-symbol-box'}">
                    <div class="tp-pinyin">
                        <span class="tp-sm">${desc ? desc[0] : ''}</span>
                        <span class="tp-ym">${desc ? desc[1] : ''}</span>
                    </div>
                    <div class="tp-word">${word}</div>
                    <div class="tp-keys">
                        <span class="tp-sm">${dmap ? rvKeyMap[dmap[0]] : ''}</span>
                        <span class="tp-ym">${dmap ? rvKeyMap[dmap[1]] : ''}</span>
                    </div>
                </div>
                `;
            }
            html += '</article>';

            document.body.innerHTML = html;
        }
        
        init() {
            this.createView();
            this.el = document.querySelector('.typing-panel');
            this.words = Array.from(document.querySelectorAll('.typing-panel > .tp-word-box'));
            this.length = this.words.length;
            this.current = {
                position: 0,
                state: TypingPanel.wordState.initial
            }
        }

        nextStep() {
            if(this.current.position === this.words.length - 1 && this.current.state === TypingPanel.wordState.wordEnterFinish) return;

            if(this.current.state === TypingPanel.wordState.initial) {
                if(this.current.position !== 0) throw new Error();
                this.current.state = TypingPanel.wordState.waitingEnterSm;
                
            } else if (this.current.state === TypingPanel.wordState.waitingEnterSm) {
                this.current.state = TypingPanel.wordState.waitingEnterYm;

            } else if (this.current.state === TypingPanel.wordState.waitingEnterYm) {
                this.current.state = TypingPanel.wordState.wordEnterFinish;

            } else if (this.current.state === TypingPanel.wordState.wordEnterFinish) {
                this.current.position++;
                this.current.state = TypingPanel.wordState.waitingEnterSm;
                
            } else {
                throw new Error();
            }

            let word = this.words[this.current.position],
                state = this.current.state;

            if(this.current.state === TypingPanel.wordState.waitingEnterSm) {
                word.classList.add('waiting-enter-sm');
            } else if (this.current.state === TypingPanel.wordState.waitingEnterYm) {
                word.classList.remove('waiting-enter-sm');
                word.classList.add('waiting-enter-ym');
            } else if (this.current.state === TypingPanel.wordState.wordEnterFinish) {
                word.classList.remove('waiting-enter-ym');
                word.classList.add('word-enter-finish');
                this.nextStep();
            }
        }
    }

    TypingPanel.wordState = {
        initial: 0,
        waitingEnterSm: 1,
        waitingEnterYm: 2,
        wordEnterFinish: 3
    }

    window.tpl = new TypingPanel();
    </script>
</body>
</html>