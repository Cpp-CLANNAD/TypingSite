<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="component/TipKeyboard/TipKeyboard.css">
    <link rel="stylesheet" href="component/TypingPanel/TypingPanel.css">
    <style>
        html, body {
            height: 100%;
        }
        body {
            margin: 0;
        }
    </style>
</head>
<body>

    <label><input type="checkbox" id="s1" checked>显示已完成</label>
    <label><input type="checkbox" id="s2" checked>显示拼音提示</label>
    <label><input type="checkbox" id="s3" checked>显示双拼提示</label>

    <label><input type="checkbox" id="s4" checked>显示键盘声母</label>
    <label><input type="checkbox" id="s5" checked>显示键盘韵母</label>
    <label><input type="checkbox" id="s6" checked>显示按键提示</label>

    <script>
        s1.onchange = function(ev) {
            tpl.el.classList.toggle('hidden-over');
        }

        s2.onchange = function(ev) {
            tpl.el.classList.toggle('no-pinyin');
        }

        s3.onchange = function(ev) {
            tpl.el.classList.toggle('no-shuangpin');
        }

        s4.onchange = function(ev) {
            tpk.el.classList.toggle('no-sm');
        }

        s5.onchange = function(ev) {
            tpk.el.classList.toggle('no-ym');
        }

        s6.onchange = function(ev) {
            tpk.el.classList.toggle('no-key-tip');
        }
     </script>

    <script>
    var article = [
        {
            "word": "偶",
            "desc": ["ǒu"],
            "dmap": ["ou"]
        },
        {
            "word": "昂",
            "desc": ["áng"],
            "dmap": ["ang"]
        },
        {
            "word": "天",
            "desc": ["t", "iān"],
            "dmap": ["t", "ian"]
        },
        {
            "word": "只",
            "desc": ["zh", "ǐ"],
            "dmap": ["zh", "i"]
        },
        {
            "word": "啊",
            "desc": ["a"],
            "dmap": ["a"]
        },
        {
            "word": "！"
        }
    ];
    // article = [...article, ...article, ...article];article = [...article, ...article, ...article];article = [...article, ...article, ...article];
    </script>
    <script src="shuangpinKeyMap.js"></script>
    <script src="https://cdn.bootcss.com/EventEmitter/5.2.3/EventEmitter.min.js"></script>
    <script src="component/TipKeyboard/TipKeyboard.js"></script>
    <script src="component/TypingPanel/TypingPanel.js"></script>
    <script>


            fetch('http://nfwsa.com:8001/api/article/convert', {
                method: 'post',
                body: window.prompt('text')
            })
            .then(res => res.json())
            .then(json => {
                console.log(json);
                tpl.init(json.article);
            })
            .catch(err => {
                console.log(err);
            });

        tpk = new TipKeyboard(shuangpinKeyMap['小鹤双拼']['key_map']);

        tpl = new TypingPanel(shuangpinKeyMap['小鹤双拼']['key_map'], shuangpinKeyMap['小鹤双拼']['0']);

        var cancelLast = _ => null;
        tpl.on('needkey', info => {
            console.log(info);
            cancelLast();
            if(info.type === 'sm') {
                tpk.highlightKey(info.key, true);
                tpk.highlightShengmu(info.py, true);
                cancelLast = _ => {
                    tpk.highlightKey(info.key, false);
                    tpk.highlightShengmu(info.py, false);
                }
            }

            if(info.type === 'ym') {
                tpk.highlightKey(info.key, true);
                tpk.highlightYunmu(info.py, true);
                cancelLast = _ => {
                    tpk.highlightKey(info.key, false);
                    tpk.highlightYunmu(info.py, false);
                }
            }
        });

        tpl.on('typingover', _ => {
            var audio = new Audio('sound/finished.mp3');
                audio.play();
            //alert('敲完了');
            cancelLast();
        });
        tpl.init(article);

        document.body.appendChild(tpl.el);

        tpk.on('keypress', key => {
            keyPress(ev.key);
        })

        window.addEventListener('keypress', ev => {
            keyPress(ev.key);
        });

        function keyPress(key) {
            if(tpl.current.state != TypingPanel.wordState.wordEnterFinish) {
                if(tpl.enterKey(key) === false) {
                    keyMiss();
                }
                else
                    keySuccess();
            }
        }

        function keyMiss() {
            var audio = new Audio('sound/miss.mp3');
                audio.play();
        }

        function keySuccess() {
            // 两套声音方案
            var audio = new Audio('sound/key_press_00.mp3');
            //var audio = new Audio('sound/key_press_0' + Number.parseInt(Math.random() * 4) + '.wav');
                audio.play();
        }

        document.body.appendChild(tpk.el);
        tpk.el.style.position = 'fixed';
        tpk.el.style.bottom = '0';


    </script>
</body>
</html>
